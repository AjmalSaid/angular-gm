/**
 * AngularGM - Google Maps Directives for AngularJS
 * @version v0.0.2 - 2013-06-25
 * @link http://dylanfprice.github.com/angular-gm
 * @author Dylan Price <the.dylan.price@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";!function(){angular.module("AngularGM",[]).value("angulargmDefaults",{mapOptions:{zoom:8,center:new google.maps.LatLng(46,-120),mapTypeId:google.maps.MapTypeId.ROADMAP}})}(),function(){angular.module("AngularGM").directive("gmMap",["$timeout",function(a){function b(b,c,d,e){if(angular.isDefined(b.gmCenter)||(b.center={}),angular.isDefined(b.gmBounds)||(b.bounds={}),!angular.isDefined(b.gmMapId))throw"angulargm must have non-empty gmMapId attribute";var f=!1,g=!1,h=!1;d.hasOwnProperty("gmCenter")&&(f=!0),d.hasOwnProperty("gmZoom")&&(g=!0),d.hasOwnProperty("gmBounds")&&(h=!0);var i=function(){a(function(){(f||g||h)&&b.$apply(function(){if(f&&(b.gmCenter=e.center),g&&(b.gmZoom=e.zoom),h){var a=e.bounds;a&&(b.gmBounds=a)}})})};e.addMapListener("drag",i),e.addMapListener("zoom_changed",i),e.addMapListener("center_changed",i),e.addMapListener("bounds_changed",i),f&&b.$watch("gmCenter",function(a,b){var c=a!==b;if(c&&!e.dragging){var d=a;d&&(e.center=d)}},!0),g&&b.$watch("gmZoom",function(a,b){var c=null!=a&&!isNaN(a);c&&a!==b&&(e.zoom=a)}),h&&b.$watch("gmBounds",function(a,b){var c=a!==b;if(c&&!e.dragging){var d=a;d&&(e.bounds=d)}})}return{restrict:"AE",priority:100,template:'<div><div id="" style="width:100%;height:100%;"></div><div ng-transclude></div></div>',transclude:!0,replace:!0,scope:{gmCenter:"=",gmZoom:"=",gmBounds:"=",gmMapOptions:"&",gmMapId:"&"},controller:"angulargmMapController",link:b}}])}(),function(){angular.module("AngularGM").directive("gmMarkers",["$log","$parse","$timeout","angulargmUtils",function(a,b,c,d){function e(a,d,e,g){if(!("gmObjects"in e))throw"gmObjects attribute required";if(!("gmGetLatLng"in e))throw"gmGetLatLng attribute required";var h={};angular.forEach(e,function(a,c){if(0===c.lastIndexOf("gmOn",0)){var d=angular.lowercase(c.substring(4)),e=b(a);h[d]=e}});var i=function(b){var d={};angular.forEach(b,function(b){var e=a.gmGetLatLng({object:b}),i=f(e);if(null!=i){var j=a.gmGetMarkerOptions({object:b}),k=i.toUrlValue(g.precision);if(d[k]=b,!g.hasMarker(e.lat,e.lng)){var l={};angular.extend(l,j,{position:i}),g.addMarker(l);var m=g.getMarker(e.lat,e.lng);angular.forEach(h,function(d,e){g.addListener(m,e,function(){c(function(){d(a.$parent.$parent,{object:b,marker:m})})})})}}});var i=[];g.forEachMarker(function(a){var b=a.getPosition(),c=b.toUrlValue(g.precision);c in d||i.push(a)}),angular.forEach(i,function(a){var b=a.getPosition();g.removeMarker(b.lat(),b.lng())}),a.$emit("gmMarkersUpdated",e.gmObjects)};a.$watch("gmObjects().length",function(b,c){null!=b&&b!==c&&i(a.gmObjects())}),a.$watch("gmObjects()",function(b,c){null!=b&&b!==c&&i(a.gmObjects())}),a.$watch("gmEvents()",function(a,b){null!=a&&a!==b&&angular.forEach(a,function(a){var b=a.event,d=a.locations;angular.forEach(d,function(a){var d=g.getMarker(a.lat(),a.lng());null!=d&&c(angular.bind(this,g.trigger,d,b))})})}),a.$on("gmMarkersRedraw",function(b,c){c===e.gmObjects&&(i(),i(a.gmObjects()))}),c(angular.bind(null,i,a.gmObjects()))}d.latLngEqual;var f=d.objToLatLng;return{restrict:"AE",priority:100,scope:{gmObjects:"&",gmGetLatLng:"&",gmGetMarkerOptions:"&",gmEvents:"&"},require:"^gmMap",link:e}}])}(),function(){angular.module("AngularGM").factory("angulargmContainer",["$q",function(a){function b(a,b){if(!(b instanceof google.maps.Map))throw"map not a google.maps.Map: "+b;if(a in g)throw"already contain map with id "+a;g[a]=b,a in h&&h[a].resolve(b)}function c(a){return g[a]}function d(b){var c=h[b]||a.defer();return h[b]=c,c.promise}function e(a){a in g&&delete g[a],a in h&&delete h[a]}function f(){g={},h={}}var g={},h={};return{addMap:b,getMap:c,getMapPromise:d,removeMap:e,clear:f}}])}(),function(){angular.module("AngularGM").factory("angulargmUtils",[function(){function a(a,b){return Math.abs(a-b)<1e-6}function b(b,c){return b instanceof google.maps.LatLng&&c instanceof google.maps.LatLng?a(b.lat(),c.lat())&&a(b.lng(),c.lng()):!1}function c(a,c){if(!(a instanceof google.maps.LatLngBounds&&c instanceof google.maps.LatLngBounds))return!1;var d=a.getSouthWest(),e=c.getSouthWest(),f=a.getNorthEast(),g=c.getNorthEast();return b(d,e)&&b(f,g)}function d(a){if(!(a instanceof google.maps.LatLng))throw"latLng not a google.maps.LatLng";return{lat:a.lat(),lng:a.lng()}}function e(a){if(null!=a){var b=a.lat,c=a.lng,d=!(null==b||null==c||isNaN(b)||isNaN(c));if(d)return new google.maps.LatLng(b,c)}return null}function f(a){if(!(a instanceof google.maps.LatLng))throw"latLng must be a google.maps.LatLng";var b=null==a.lat()||null==a.lng(),c=isNaN(a.lat())||isNaN(a.lng());return b||c}return{latLngEqual:b,boundsEqual:c,latLngToObj:d,objToLatLng:e,hasNaN:f}}])}(),function(){angular.module("AngularGM").controller("angulargmMapController",["$scope","$element","angulargmUtils","angulargmDefaults","angulargmContainer",function(a,b,c,d,e){var f=c.latLngEqual,g=c.boundsEqual,h=c.hasNaN,i=d,j=e,k={};k.precision=3;var l=function(a,b){var c=a.gmMapId();if(!c)throw"angulargm must have non-empty gmMapId attribute";var d=b.find("[id]");d.attr("id",c);var e=this._getConfig(a,i);this._map=this._createMap(c,d,e,j),this._markers={},this.dragging=!1,Object.defineProperties(this,{precision:{value:k.precision,writeable:!1},center:{configurable:!0,get:function(){return this._map.getCenter()},set:function(a){if(h(a))throw"center contains null or NaN";var b=!f(this.center,a);b&&this._map.panTo(a)}},zoom:{configurable:!0,get:function(){return this._map.getZoom()},set:function(a){if(null==a||isNaN(a))throw"zoom was null or NaN";var b=this.zoom!==a;b&&this._map.setZoom(a)}},bounds:{configurable:!0,get:function(){return this._map.getBounds()},set:function(a){var b=!h(a.getSouthWest())&&!h(a.getNorthEast());if(!b)throw"bounds contains null or NaN";var c=!g(this.bounds,a);c&&this._map.fitBounds(a)}}}),this._initDragListeners(),a.$on("$destroy",angular.bind(this,this._destroy,c))};this._getConfig=function(a,b){var c=b.mapOptions,d={};return angular.extend(d,c,a.gmMapOptions()),d},this._createMap=function(a,b,c,d){var e=d.getMap(a);if(e)throw"A map with id "+a+" already exists. You must use"+" different ids for each instance of the angulargm directive.";return e=new google.maps.Map(b[0],c),d.addMap(a,e),e},this._initDragListeners=function(){var a=this;this.addMapListener("dragstart",function(){a.dragging=!0}),this.addMapListener("idle",function(){a.dragging=!1}),this.addMapListener("drag",function(){a.dragging=!0})},this._destroy=function(a){j.removeMap(a)},this.addMapListener=function(a,b){google.maps.event.addListener(this._map,a,b)},this.addMapListenerOnce=function(a,b){google.maps.event.addListenerOnce(this._map,a,b)},this.addListener=function(a,b,c){google.maps.event.addListener(a,b,c)},this.addListenerOnce=function(a,b,c){google.maps.event.addListenerOnce(a,b,c)},this.mapTrigger=function(a){google.maps.event.trigger(this._map,a)},this.trigger=function(a,b){google.maps.event.trigger(a,b)},this.addMarker=function(a){var b={};if(angular.extend(b,a),!(b.position instanceof google.maps.LatLng))throw"markerOptions did not contain a position";var c=new google.maps.Marker(b),d=c.getPosition();if(this.hasMarker(d.lat(),d.lng()))return!1;var e=d.toUrlValue(this.precision);return this._markers[e]=c,c.setMap(this._map),!0},this.hasMarker=function(a,b){return this.getMarker(a,b)instanceof google.maps.Marker},this.getMarker=function(a,b){if(null==a||null==b)throw"lat or lng was null";var c=new google.maps.LatLng(a,b),d=c.toUrlValue(this.precision);return d in this._markers?this._markers[d]:null},this.removeMarker=function(a,b){if(null==a||null==b)throw"lat or lng was null";var c=new google.maps.LatLng(a,b),d=!1,e=c.toUrlValue(this.precision),f=this._markers[e];return f&&(f.setMap(null),d=!0),this._markers[e]=null,delete this._markers[e],d},this.fitToMarkers=function(){var a=new google.maps.LatLngBounds;this.forEachMarker(function(b){a.extend(b.getPosition())}),this.bounds=a},this.forEachMarker=function(a){if(null==a)throw"fn was null or undefined";angular.forEach(this._markers,function(b){null!=b&&a(b)})},angular.bind(this,l)(a,b)}])}();